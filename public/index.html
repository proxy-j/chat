<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>The Chet</title>
Â  Â  <link rel="icon" type="image/png" id="favicon">
Â  Â  <style>
Â  Â  Â  Â  * {margin: 0;padding: 0;box-sizing: border-box;}
Â  Â  Â  Â  body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;height: 100vh;overflow: hidden;background: #36393f;}
Â  Â  Â  Â  .container {display: flex;height: 100vh;}
Â  Â  Â  Â  .sidebar {width: 240px;background: #2f3136;display: flex;flex-direction: column;}
Â  Â  Â  Â  .server-header {height: 48px;padding: 0 16px;display: flex;align-items: center;border-bottom: 1px solid #202225;color: #fff;font-weight: 600;font-size: 15px;}
Â  Â  Â  Â  .channels {flex: 1;overflow-y: auto;padding: 8px;}
Â  Â  Â  Â  .channel-section {margin-bottom: 16px;}
Â  Â  Â  Â  .section-header {color: #96989d;font-size: 12px;font-weight: 600;text-transform: uppercase;margin-bottom: 4px;padding: 0 8px;}
Â  Â  Â  Â  .channel {padding: 8px 12px;margin: 2px 0;border-radius: 4px;color: #96989d;cursor: pointer;display: flex;align-items: center;justify-content: space-between;font-size: 14px;transition: all 0.15s;position: relative;}
Â  Â  Â  Â  .channel:hover {background: #3a3c42;color: #dcddde;}
Â  Â  Â  Â  .channel.active {background: #404249;color: #fff;}
Â  Â  Â  Â  .channel-name {display: flex;align-items: center;flex: 1;}
Â  Â  Â  Â  .channel-name::before {content: '#';margin-right: 6px;font-weight: 600;color: #72767d;}
Â  Â  Â  Â  .channel.private .channel-name::before {content: 'ğŸ‘¤';margin-right: 6px;}
Â  Â  Â  Â  .channel-right {display: flex;align-items: center;gap: 4px;}
Â  Â  Â  Â  .unread-badge {background: #ed4245;color: #fff;border-radius: 10px;padding: 2px 6px;font-size: 11px;font-weight: 600;min-width: 18px;text-align: center;}
Â  Â  Â  Â  .close-dm {opacity: 0;background: transparent;border: none;color: #96989d;cursor: pointer;padding: 2px 6px;border-radius: 3px;font-size: 16px;transition: all 0.15s;}
Â  Â  Â  Â  .channel:hover .close-dm {opacity: 1;}
Â  Â  Â  Â  .close-dm:hover {background: #ed4245;color: #fff;}
Â  Â  Â  Â  .online-users {padding: 8px;border-top: 1px solid #202225;max-height: 200px;overflow-y: auto;display: none;} /* HIDDEN/MOVED */
Â  Â  Â  Â  .online-header {color: #96989d;font-size: 12px;font-weight: 600;text-transform: uppercase;margin-bottom: 8px;}
Â  Â  Â  Â  .user-area {height: 52px;background: #292b2f;padding: 0 8px;display: flex;align-items: center;border-top: 1px solid #202225;}
Â  Â  Â  Â  .user-info {display: flex;align-items: center;flex: 1; min-width: 0;}
Â  Â  Â  Â  .user-avatar {width: 32px;height: 32px;border-radius: 50%;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);display: flex;align-items: center;justify-content: center;color: #fff;font-weight: 600;margin-right: 8px;flex-shrink: 0;}
Â  Â  Â  Â  .username {color: #fff;font-size: 14px;font-weight: 500;white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
Â  Â  Â  Â  .connection-status {width: 8px;height: 8px;border-radius: 50%;background: #ed4245;margin-left: 8px;}
Â  Â  Â  Â  .connection-status.connected {background: #3ba55d;}
Â  Â  Â  Â  .admin-lock-btn {background: none; border: none; color: #96989d; cursor: pointer; font-size: 18px; margin-left: 8px; transition: color 0.15s;}
Â  Â  Â  Â  .admin-lock-btn:hover {color: #dcddde;}
Â  Â  Â  Â  .admin-lock-btn.active {color: #fce205;}
Â  Â  Â  Â  .main-content {flex: 1;display: flex;flex-direction: column;background: #36393f;}
Â  Â  Â  Â  .chat-header {height: 48px;padding: 0 16px;display: flex;align-items: center;justify-content: space-between;border-bottom: 1px solid #202225;color: #fff;}
Â  Â  Â  Â  .channel-name-header {font-weight: 600;font-size: 16px;}
Â  Â  Â  Â  .channel-name-header::before {content: '#';margin-right: 4px;color: #72767d;}
Â  Â  Â  Â  .channel-name-header.private::before {content: 'ğŸ‘¤';}
Â  Â  Â  Â  .typing-indicator {font-size: 12px;color: #72767d;font-style: italic;}
Â  Â  Â  Â  .messages {flex: 1;overflow-y: auto;padding: 16px;}
Â  Â  Â  Â  .message {display: flex;padding: 4px 0;margin-bottom: 12px;}
Â  Â  Â  Â  .message:hover {background: #32353b;margin: 0 -16px 12px;padding: 4px 16px;}
Â  Â  Â  Â  .message-avatar {width: 40px;height: 40px;border-radius: 50%;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);display: flex;align-items: center;justify-content: center;color: #fff;font-weight: 600;margin-right: 16px;flex-shrink: 0;}
Â  Â  Â  Â  .message-content {flex: 1;}
Â  Â  Â  Â  .message-header {display: flex;align-items: baseline;margin-bottom: 4px;}
Â  Â  Â  Â  .message-author {color: #fff;font-weight: 500;font-size: 15px;margin-right: 8px;}
Â  Â  Â  Â  .message-timestamp {color: #72767d;font-size: 12px;}
Â  Â  Â  Â  .message-text {color: #dcddde;font-size: 15px;line-height: 1.4;word-wrap: break-word;}
Â  Â  Â  Â  .message-image {margin-top: 8px;max-width: 400px;max-height: 300px;border-radius: 8px;cursor: pointer;transition: transform 0.2s;display: block;}
Â  Â  Â  Â  .message-image:hover {transform: scale(1.02);}
Â  Â  Â  Â  .input-area {padding: 16px;}
Â  Â  Â  Â  .input-wrapper {background: #40444b;border-radius: 8px;padding: 12px;display: flex;align-items: center;}
Â  Â  Â  Â  .attach-btn {background: transparent;border: none;color: #b9bbbe;cursor: pointer;font-size: 20px;padding: 4px 8px;margin-right: 8px;transition: color 0.2s;}
Â  Â  Â  Â  .attach-btn:hover {color: #dcddde;}
Â  Â  Â  Â  .message-input {flex: 1;background: none;border: none;color: #dcddde;font-size: 15px;outline: none;}
Â  Â  Â  Â  .message-input::placeholder {color: #72767d;}
Â  Â  Â  Â  .send-btn {background: #5865f2;color: #fff;border: none;padding: 8px 16px;border-radius: 4px;cursor: pointer;font-weight: 500;margin-left: 8px;transition: background 0.2s;}
Â  Â  Â  Â  .send-btn:hover {background: #4752c4;}
Â  Â  Â  Â  .send-btn:active {background: #3c45a5;}
Â  Â  Â  Â  .send-btn:disabled {background: #4e5058;cursor: not-allowed;}
Â  Â  Â  Â  .file-input {display: none;}
Â  Â  Â  Â  .image-preview {position: relative;display: inline-block;margin-right: 8px;}
Â  Â  Â  Â  .preview-image {max-width: 100px;max-height: 100px;border-radius: 4px;}
Â  Â  Â  Â  .remove-preview {position: absolute;top: -8px;right: -8px;background: #ed4245;color: #fff;border: none;border-radius: 50%;width: 20px;height: 20px;cursor: pointer;font-size: 12px;display: flex;align-items: center;justify-content: center;}
Â  Â  Â  Â  .notifications {position: fixed;top: 16px;right: 16px;z-index: 1000;display: flex;flex-direction: column;gap: 12px;max-width: 400px;}
Â  Â  Â  Â  .notification {background: #2f3136;border: 1px solid #202225;border-radius: 8px;padding: 16px;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);animation: slideIn 0.3s ease;}
Â  Â  Â  Â  @keyframes slideIn {from {transform: translateX(400px);opacity: 0;}to {transform: translateX(0);opacity: 1;}}
Â  Â  Â  Â  .notification-header {color: #fff;font-weight: 600;font-size: 14px;margin-bottom: 8px;}
Â  Â  Â  Â  .notification-body {color: #dcddde;font-size: 14px;margin-bottom: 12px;}
Â  Â  Â  Â  .notification-actions {display: flex;gap: 8px;}
Â  Â  Â  Â  .notification-btn {flex: 1;padding: 8px;border: none;border-radius: 4px;font-weight: 500;cursor: pointer;transition: all 0.2s;}
Â  Â  Â  Â  .btn-accept {background: #3ba55d;color: #fff;}
Â  Â  Â  Â  .btn-accept:hover {background: #2d7d46;}
Â  Â  Â  Â  .btn-decline {background: #ed4245;color: #fff;}
Â  Â  Â  Â  .btn-decline:hover {background: #c03537;}
Â  Â  Â  Â  .image-modal {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.9);z-index: 2000;justify-content: center;align-items: center;}
Â  Â  Â  Â  .image-modal.active {display: flex;}
Â  Â  Â  Â  .modal-image {max-width: 90%;max-height: 90%;border-radius: 8px;}
Â  Â  Â  Â  .close-modal {position: absolute;top: 20px;right: 20px;background: #ed4245;color: #fff;border: none;border-radius: 50%;width: 40px;height: 40px;font-size: 24px;cursor: pointer;}
Â  Â  Â  Â  ::-webkit-scrollbar {width: 8px;}
Â  Â  Â  Â  ::-webkit-scrollbar-track {background: #2f3136;}
Â  Â  Â  Â  ::-webkit-scrollbar-thumb {background: #202225;border-radius: 4px;}
Â  Â  Â  Â  ::-webkit-scrollbar-thumb:hover {background: #1a1c1f;}
/* NEW STYLES FOR RIGHT USER SIDEBAR AND ADMIN POPUP */
Â  Â  Â  Â  .user-sidebar {width: 240px;background: #2f3136;display: flex;flex-direction: column;border-left: 1px solid #202225;}
Â  Â  Â  Â  .online-users-right {flex: 1;overflow-y: auto;padding: 8px;}
Â  Â  Â  Â  .user-list-item {padding: 4px 8px;color: #dcddde;font-size: 14px;display: flex;align-items: center;justify-content: space-between;border-radius: 4px;transition: background 0.15s;cursor: pointer;position: relative;}
Â  Â  Â  Â  .user-list-item:hover {background: #3a3c42;}
Â  Â  Â  Â  .user-name {display: flex;align-items: center;font-weight: 500;}
Â  Â  Â  Â  .user-name::before {content: 'â—';color: #3ba55d;margin-right: 6px;font-size: 10px;}
Â  Â  Â  Â  .user-name.muted::before {content: 'ğŸ”‡';color: #fce205;margin-right: 6px;font-size: 14px;}
Â  Â  Â  Â  .dm-btn {background: #5865f2;color: #fff;border: none;padding: 2px 8px;border-radius: 3px;font-size: 11px;cursor: pointer;transition: all 0.15s;}
Â  Â  Â  Â  .dm-btn:hover {background: #4752c4;}
Â  Â  Â  Â  .admin-actions-popup {position: absolute;right: 100%;top: 50%;transform: translateY(-50%);background: #202225;border-radius: 4px;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);z-index: 10;min-width: 150px;padding: 4px 0;}
Â  Â  Â  Â  .admin-action-btn {display: block;width: 100%;padding: 8px 12px;background: none;border: none;color: #dcddde;text-align: left;cursor: pointer;font-size: 14px;transition: background 0.15s;}
Â  Â  Â  Â  .admin-action-btn:hover {background: #404249;}
Â  Â  Â  Â  .admin-action-btn.ban {color: #ed4245;}
Â  Â  Â  Â  .admin-action-btn.kick {color: #5865f2;}
Â  Â  Â  Â  .muted-indicator {color: #fce205;margin-left: 4px;font-size: 14px;}
Â  Â  </style>
</head>
<body>
Â  Â  <div class="notifications" id="notifications"></div>
Â  Â  <div class="image-modal" id="imageModal">
Â  Â  Â  Â  <button class="close-modal" id="closeModalBtn">Ã—</button>
Â  Â  Â  Â  <img class="modal-image" id="modalImage" src="" alt="Full size image">
Â  Â  </div>
Â  Â  <div class="container">
Â  Â  Â  Â  <div class="sidebar">
Â  Â  Â  Â  Â  Â  <div class="server-header">The Chet</div>
Â  Â  Â  Â  Â  Â  <div class="channels" id="channelList">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="section-header">Channels</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel active" data-channel="general"><span class="channel-name">general</span><div class="channel-right"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel" data-channel="random"><span class="channel-name">random</span><div class="channel-right"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel" data-channel="gaming"><span class="channel-name">gaming</span><div class="channel-right"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel" data-channel="memes"><span class="channel-name">memes</span><div class="channel-right"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="section-header">Direct Messages</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="dmList"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="user-area">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-avatar" id="userAvatar">U</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="username" id="usernameDisplay">User</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="connection-status" id="connectionStatus"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="admin-lock-btn" id="adminLockBtn" title="Admin Login">ğŸ”’</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="main-content">
Â  Â  Â  Â  Â  Â  <div class="chat-header">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel-name-header" id="currentChannel">general</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="typing-indicator" id="typingIndicator"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="messages" id="messageArea"></div>
Â  Â  Â  Â  Â  Â  <div class="input-area">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" class="file-input" id="fileInput" accept="image/*">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="attach-btn" id="attachBtn">ğŸ“</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="imagePreviewContainer"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="message-input" id="messageInput" placeholder="Message #general" maxlength="150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="send-btn" id="sendBtn">Send</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="user-sidebar">
Â  Â  Â  Â  Â  Â  <div class="server-header">Online Users</div>
Â  Â  Â  Â  Â  Â  <div class="online-users-right" id="userList"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <script>
const WS_URL=window.location.protocol==='https:'?`wss://${window.location.host}`:`ws://${window.location.hostname}:${window.location.port||3000}`;const state={currentChannel:'general',currentChatType:'channel',currentPrivateChat:null,username:'',ws:null,connected:false,messages:{},privateMessages:{},users:[],typingUsers:{},privateChats:{},selectedImage:null,unreadCounts:{},isTabActive:true,totalUnread:0,originalFavicon:null,isAdmin:false,isMuted:false,adminTargetUser:null};const messageArea=document.getElementById('messageArea'),messageInput=document.getElementById('messageInput'),sendBtn=document.getElementById('sendBtn'),channelList=document.getElementById('channelList'),dmList=document.getElementById('dmList'),currentChannelEl=document.getElementById('currentChannel'),usernameDisplay=document.getElementById('usernameDisplay'),userAvatar=document.getElementById('userAvatar'),connectionStatus=document.getElementById('connectionStatus'),userList=document.getElementById('userList'),typingIndicator=document.getElementById('typingIndicator'),notifications=document.getElementById('notifications'),fileInput=document.getElementById('fileInput'),attachBtn=document.getElementById('attachBtn'),imagePreviewContainer=document.getElementById('imagePreviewContainer'),imageModal=document.getElementById('imageModal'),modalImage=document.getElementById('modalImage'),closeModalBtn=document.getElementById('closeModalBtn'),favicon=document.getElementById('favicon'),adminLockBtn=document.getElementById('adminLockBtn');let typingTimeout;function createDefaultFavicon(){const canvas=document.createElement('canvas');canvas.width=32;canvas.height=32;const ctx=canvas.getContext('2d');ctx.fillStyle='#5865f2';ctx.fillRect(0,0,32,32);ctx.fillStyle='#fff';ctx.font='bold 20px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('C',16,16);return canvas.toDataURL()}function updateFavicon(hasNotification){const canvas=document.createElement('canvas');canvas.width=32;canvas.height=32;const ctx=canvas.getContext('2d');const img=new Image();img.onload=()=>{ctx.drawImage(img,0,0,32,32);if(hasNotification){ctx.fillStyle='#ed4245';ctx.beginPath();ctx.arc(24,8,8,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke()}favicon.href=canvas.toDataURL()};img.src=state.originalFavicon||createDefaultFavicon()}function updateTitle(){if(state.totalUnread>0){document.title=`(${state.totalUnread}) The Chet`}else{document.title='The Chet'}}function incrementUnread(channelId){if(!state.isTabActive||(state.currentChatType==='channel'&&state.currentChannel!==channelId)||(state.currentChatType==='private'&&state.currentPrivateChat!==channelId)){if(!state.unreadCounts[channelId])state.unreadCounts[channelId]=0;state.unreadCounts[channelId]++;state.totalUnread++;updateTitle();updateFavicon(true);updateChannelBadges()}}function clearUnread(channelId){if(state.unreadCounts[channelId]){state.totalUnread-=state.unreadCounts[channelId];state.unreadCounts[channelId]=0;updateTitle();updateFavicon(state.totalUnread>0);updateChannelBadges()}}function updateChannelBadges(){document.querySelectorAll('.channel').forEach(ch=>{const rightDiv=ch.querySelector('.channel-right');if(!rightDiv)return;rightDiv.querySelectorAll('.unread-badge').forEach(b=>b.remove());const channelId=ch.dataset.channel||ch.dataset.chatId;if(state.unreadCounts[channelId]&&state.unreadCounts[channelId]>0){const badge=document.createElement('span');badge.className='unread-badge';badge.textContent=state.unreadCounts[channelId];rightDiv.insertBefore(badge,rightDiv.firstChild)}})}document.addEventListener('visibilitychange',()=>{state.isTabActive=!document.hidden;if(state.isTabActive){const currentId=state.currentChatType==='channel'?state.currentChannel:state.currentPrivateChat;clearUnread(currentId)}});function init(){state.originalFavicon=createDefaultFavicon();favicon.href=state.originalFavicon;const n=prompt('Enter your username:','User')||'User';state.username=n;usernameDisplay.textContent=n;userAvatar.textContent=n.charAt(0).toUpperCase();connectWebSocket()}function connectWebSocket(){try{state.ws=new WebSocket(WS_URL)}catch(e){setTimeout(connectWebSocket,3000);return}state.ws.onopen=()=>{state.connected=true;connectionStatus.classList.add('connected');sendBtn.disabled=false;send({type:'join',username:state.username});send({type:'getHistory',channel:state.currentChannel})};state.ws.onmessage=e=>{try{handleServerMessage(JSON.parse(e.data))}catch(er){}};state.ws.onclose=()=>{state.connected=false;connectionStatus.classList.remove('connected');sendBtn.disabled=true;setTimeout(connectWebSocket,3000)};state.ws.onerror=e=>{}}function handleServerMessage(d){switch(d.type){case'message':addMessageToChannel(d.message);break;case'history':loadHistory(d.channel,d.messages);break;case'userList':updateUserList(d.users);break;case'typing':handleTypingIndicator(d);break;case'privateChatRequest':showPrivateChatRequest(d.from);break;case'privateChatAccepted':handlePrivateChatAccepted(d.chatId,d.with);break;case'privateChatRejected':alert(`${d.by} declined`);break;case'privateMessage':addPrivateMessage(d.message);break;case'privateHistory':loadPrivateHistory(d.chatId,d.messages);break;case'adminStatus':state.isAdmin=d.isAdmin;adminLockBtn.classList.toggle('active',d.isAdmin);break;case'kicked':alert('You have been kicked! Redirecting to Google...');window.location.href='https://www.google.com';break;case'muted':state.isMuted=true;messageInput.disabled=true;messageInput.placeholder=`You are muted${d.duration==='forever'?' permanently':` for ${d.duration/60000} minutes`}. Cannot send messages.`;break;case'unmuted':state.isMuted=false;messageInput.disabled=false;messageInput.placeholder=`Message #${state.currentChannel}`;break;case'error':alert(`Server Error: ${d.message}`);break}}function send(d){if(state.ws&&state.ws.readyState===WebSocket.OPEN)state.ws.send(JSON.stringify(d))}function showPrivateChatRequest(from){const n=document.createElement('div');n.className='notification';n.innerHTML=`<div class="notification-header">Private Chat Request</div><div class="notification-body">${from} wants to chat</div><div class="notification-actions"><button class="notification-btn btn-accept">Accept</button><button class="notification-btn btn-decline">Decline</button></div>`;n.querySelector('.btn-accept').onclick=()=>{send({type:'privateChatResponse',from,accepted:true});n.remove()};n.querySelector('.btn-decline').onclick=()=>{send({type:'privateChatResponse',from,accepted:false});n.remove()};notifications.appendChild(n)}function handlePrivateChatAccepted(chatId,withUser){state.privateChats[chatId]=withUser;addDMToList(chatId,withUser);switchToPrivateChat(chatId,withUser)}function addDMToList(chatId,username){if(document.querySelector(`[data-chat-id="${chatId}"]`))return;const d=document.createElement('div');d.className='channel private';d.dataset.chatId=chatId;d.innerHTML=`<span class="channel-name">${username}</span><div class="channel-right"><button class="close-dm">Ã—</button></div>`;d.querySelector('.close-dm').onclick=e=>{e.stopPropagation();d.remove();delete state.privateChats[chatId];delete state.privateMessages[chatId];if(state.unreadCounts[chatId]){state.totalUnread-=state.unreadCounts[chatId];delete state.unreadCounts[chatId];updateTitle();updateFavicon(state.totalUnread>0)}if(state.currentPrivateChat===chatId)switchChannel('general')};d.onclick=()=>switchToPrivateChat(chatId,username);dmList.appendChild(d)}function switchToPrivateChat(chatId,username){const oldId=state.currentChatType==='channel'?state.currentChannel:state.currentPrivateChat;if(oldId)clearUnread(oldId);state.currentChatType='private';state.currentPrivateChat=chatId;state.currentChannel=username;currentChannelEl.textContent=username;currentChannelEl.classList.add('private');messageInput.placeholder=`Message @${username}`;document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active'));const dm=document.querySelector(`[data-chat-id="${chatId}"]`);if(dm)dm.classList.add('active');if(!state.privateMessages[chatId])send({type:'getPrivateHistory',chatId});else renderMessages();state.typingUsers={};updateTypingIndicator();clearUnread(chatId)}function requestPrivateChat(username){if(username===state.username)return;send({type:'privateChatRequest',targetUsername:username})}async function compressImage(file){return new Promise(resolve=>{const reader=new FileReader();reader.onload=e=>{const img=new Image();img.onload=()=>{const canvas=document.createElement('canvas');let width=img.width,height=img.height;const maxSize=800;if(width>height){if(width>maxSize){height*=maxSize/width;width=maxSize}}else{if(height>maxSize){width*=maxSize/height;height=maxSize}}canvas.width=width;canvas.height=height;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0,width,height);canvas.toBlob(blob=>{const cr=new FileReader();cr.onloadend=()=>resolve({data:cr.result,name:file.name});cr.readAsDataURL(blob)},'image/jpeg',0.7)};img.src=e.target.result};reader.readAsDataURL(file)})}attachBtn.onclick=()=>fileInput.click();fileInput.onchange=async e=>{const file=e.target.files[0];if(!file)return;const compressed=await compressImage(file);state.selectedImage=compressed;imagePreviewContainer.innerHTML=`<div class="image-preview"><img src="${compressed.data}" class="preview-image"><button class="remove-preview">Ã—</button></div>`;imagePreviewContainer.querySelector('.remove-preview').onclick=()=>{state.selectedImage=null;imagePreviewContainer.innerHTML='';fileInput.value=''}};function addMessage(){if(state.isMuted){alert('You are muted and cannot send messages.');return;}const text=messageInput.value.trim();if(!state.connected)return;if(state.selectedImage){if(state.currentChatType==='private'){send({type:'privateImageMessage',chatId:state.currentPrivateChat,imageData:state.selectedImage.data,fileName:state.selectedImage.name,targetUsername:state.privateChats[state.currentPrivateChat]})}else{send({type:'imageMessage',channel:state.currentChannel,imageData:state.selectedImage.data,fileName:state.selectedImage.name})}state.selectedImage=null;imagePreviewContainer.innerHTML='';fileInput.value=''}else if(text){if(state.currentChatType==='private'){send({type:'privateMessage',chatId:state.currentPrivateChat,text,targetUsername:state.privateChats[state.currentPrivateChat]})}else{send({type:'message',channel:state.currentChannel,text})}}messageInput.value='';stopTyping()}function addMessageToChannel(m){if(!state.messages[m.channel])state.messages[m.channel]=[];state.messages[m.channel].push(m);if(m.author!==state.username){incrementUnread(m.channel)}if(m.channel===state.currentChannel&&state.currentChatType==='channel')renderMessages()}function addPrivateMessage(m){if(!state.privateMessages[m.chatId])state.privateMessages[m.chatId]=[];state.privateMessages[m.chatId].push(m);if(m.author!==state.username){incrementUnread(m.chatId)}if(m.chatId===state.currentPrivateChat&&state.currentChatType==='private')renderMessages()}function loadHistory(c,m){state.messages[c]=m;if(c===state.currentChannel&&state.currentChatType==='channel')renderMessages()}function loadPrivateHistory(c,m){state.privateMessages[c]=m;if(c===state.currentPrivateChat&&state.currentChatType==='private')renderMessages()}function renderMessages(){let msgs=state.currentChatType==='private'?state.privateMessages[state.currentPrivateChat]||[]:state.messages[state.currentChannel]||[];messageArea.innerHTML='';msgs.forEach(m=>{const d=document.createElement('div');d.className='message';const av=document.createElement('div');av.className='message-avatar';av.textContent=m.author.charAt(0).toUpperCase();const cont=document.createElement('div');cont.className='message-content';const hdr=document.createElement('div');hdr.className='message-header';const auth=document.createElement('span');auth.className='message-author';auth.textContent=m.author;const ts=document.createElement('span');ts.className='message-timestamp';ts.textContent=formatTime(new Date(m.timestamp));hdr.appendChild(auth);hdr.appendChild(ts);cont.appendChild(hdr);if(m.isImage){const img=document.createElement('img');img.className='message-image';img.src=m.imageData;img.alt=m.fileName||'Image';img.onclick=()=>openImageModal(m.imageData);cont.appendChild(img)}else{const txt=document.createElement('div');txt.className='message-text';txt.textContent=m.text;cont.appendChild(txt)}d.appendChild(av);d.appendChild(cont);messageArea.appendChild(d)});messageArea.scrollTop=messageArea.scrollHeight}function openImageModal(src){modalImage.src=src;imageModal.classList.add('active')}function closeImageModal(){imageModal.classList.remove('active')}closeModalBtn.onclick=closeImageModal;imageModal.onclick=e=>{if(e.target===imageModal)closeImageModal()};function updateUserList(users){state.users=users;userList.innerHTML='';users.forEach(u=>{if(u===state.username)return;const el=document.createElement('div');el.className='user-list-item';el.dataset.username=u;el.innerHTML=`<span class="user-name">${u}</span><button class="dm-btn">DM</button>`;el.querySelector('.dm-btn').onclick=e=>{e.stopPropagation();requestPrivateChat(u)};el.onclick=()=>handleUserListItemClick(u);userList.appendChild(el)});document.addEventListener('click',closeAdminPopup);}function handleUserListItemClick(username){if(!state.isAdmin||username===state.username)return;state.adminTargetUser=username;const el=document.querySelector(`.user-list-item[data-username="${username}"]`);if(!el)return;let popup=el.querySelector('.admin-actions-popup');if(popup){popup.remove();state.adminTargetUser=null;return;}popup=document.createElement('div');popup.className='admin-actions-popup';popup.innerHTML=`<button class="admin-action-btn kick">Kick to Google</button><button class="admin-action-btn ban">Permanent IP Ban</button><div class="section-header" style="padding: 4px 12px; margin-top: 4px;">Mute User</div><button class="admin-action-btn" data-action="mute" data-duration="60000">Mute 1 min</button><button class="admin-action-btn" data-action="mute" data-duration="300000">Mute 5 min</button><button class="admin-action-btn" data-action="mute" data-duration="forever">Mute Forever</button>`;popup.querySelector('.kick').onclick=(e)=>{e.stopPropagation();sendAdminAction('kick',username);closeAdminPopup();};popup.querySelector('.ban').onclick=(e)=>{e.stopPropagation();if(confirm(`Are you sure you want to permanently IP Ban ${username}?`)){sendAdminAction('ban',username);closeAdminPopup();}};popup.querySelectorAll('[data-action="mute"]').forEach(btn=>{btn.onclick=(e)=>{e.stopPropagation();sendAdminAction('mute',username,btn.dataset.duration);closeAdminPopup();}});el.appendChild(popup);el.scrollIntoView({behavior:'smooth',block:'nearest'})}function closeAdminPopup(){document.querySelectorAll('.admin-actions-popup').forEach(p=>p.remove());state.adminTargetUser=null;}function sendAdminAction(action,targetUsername,duration=null){send({type:'adminAction',action,targetUsername,duration})}function handleTypingIndicator(d){if(state.currentChatType==='private'){if(d.isPrivate&&d.username===state.privateChats[state.currentPrivateChat]){d.isTyping?state.typingUsers[d.username]=true:delete state.typingUsers[d.username];updateTypingIndicator()}}else{if(d.channel===state.currentChannel&&!d.isPrivate){d.isTyping?state.typingUsers[d.username]=true:delete state.typingUsers[d.username];updateTypingIndicator()}}}function updateTypingIndicator(){const t=Object.keys(state.typingUsers);typingIndicator.textContent=t.length===0?'':t.length===1?`${t[0]} is typing...`:`${t.length} people are typing...`}function startTyping(){if(!state.connected||state.isMuted)return;if(state.currentChatType==='private')send({type:'typing',channel:state.currentPrivateChat,isTyping:true,isPrivate:true,targetUsername:state.privateChats[state.currentPrivateChat]});else send({type:'typing',channel:state.currentChannel,isTyping:true});clearTimeout(typingTimeout);typingTimeout=setTimeout(stopTyping,3000)}function stopTyping(){if(!state.connected)return;if(state.currentChatType==='private')send({type:'typing',channel:state.currentPrivateChat,isTyping:false,isPrivate:true,targetUsername:state.privateChats[state.currentPrivateChat]});else send({type:'typing',channel:state.currentChannel,isTyping:false})}function formatTime(d){return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0')}function switchChannel(c){const oldId=state.currentChatType==='channel'?state.currentChannel:state.currentPrivateChat;if(oldId)clearUnread(oldId);state.currentChatType='channel';state.currentPrivateChat=null;state.currentChannel=c;currentChannelEl.textContent=c;currentChannelEl.classList.remove('private');messageInput.placeholder=`Message #${c}`;if(!state.isMuted)messageInput.disabled=false;document.querySelectorAll('.channel').forEach(ch=>{ch.classList.remove('active');if(ch.dataset.channel===c)ch.classList.add('active')});if(!state.messages[c])send({type:'getHistory',channel:c});else renderMessages();state.typingUsers={};updateTypingIndicator();clearUnread(c)}function handleAdminLogin(){const password=prompt('Enter Admin Password:');if(password){send({type:'adminLogin',password})}}adminLockBtn.onclick=handleAdminLogin;sendBtn.onclick=e=>{e.preventDefault();addMessage()};messageInput.onkeypress=e=>{if(e.key==='Enter'){e.preventDefault();addMessage()}};messageInput.oninput=()=>{messageInput.value.length>0?startTyping():stopTyping()};channelList.onclick=e=>{const c=e.target.closest('.channel');if(c&&c.dataset.channel)switchChannel(c.dataset.channel)};init();
Â  Â  </script>
</body>
</html>
